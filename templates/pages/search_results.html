{% extends 'layout.html' %}

{% block headline %}
    <h1 class="title">Search Results for '{{ query }}'</h1>
{% endblock headline %}

{% block content %}
    <br><ul class="no_style_type">
        {% for book in books %}
            <li>
                {% if book.volumeInfo.imageLinks and book.volumeInfo.imageLinks.thumbnail %}
                    <div class="content-section">
                        <img src="{{ book.volumeInfo.imageLinks.thumbnail }}">
                        <h2>{{ book.volumeInfo.title }}</h2>
                        <p>{{ book.volumeInfo.authors | join(', ') }}</p>
                        <p>{{ book.volumeInfo.description }}</p>
                        {% if current_user.is_authenticated %}
                            <button onclick="addToLibrary('{{ book.id }}')" class="add-button">Add to Library</button>
                        {% endif %}
                    </div>
                {% endif %}
            </li>
        {% endfor %}
    </ul>

    <script>
        function addToLibrary(bookId) {
            fetch('/add_to_library', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ book_id: bookId }),
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Failed to add book to library');
                }
                return response.json();
            })
            .then(data => {
                console.log('Book added:', data);
                if (data.requires_login) {
                    window.location.href = "{{ url_for('login_google') }}";
                } else {
                    alert('Book added successfully!');
                }
            })
            .catch(error => {
                console.error('Error adding book:', error);
                alert('Failed to add book to library');
            });
        }        
    </script>

{% endblock content %}